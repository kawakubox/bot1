# -*- mode:coffee; coding:utf-8 -*-
# Description:
#   SSH commands
#

cipher = '''
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
'''

Connection = require('ssh2')
crypto = require('crypto')
aes = crypto.createDecipher('aes-256-cbc', new Buffer(process.env['DECIPHER_PASSWORD']))
privateKey = aes.update(data, 'base64', 'utf8')
privateKey += aes.final('utf8')

module.exports = (robot) ->
  # uptimeとdfだけ許可する
  robot.respond /\s+ssh\s+(uptime|df)\s*/i, (msg) ->
    # user1とuser2だけ許可する
    return if not /^(user1|user2)$/i.test(msg.message.user.name)
    cmd = msg.match[1]

    result = ""
    conn = new Connection()
    conn.on 'ready', () ->
      console.log 'Connection :: ready'
      conn.exec cmd, (err, stream) ->
        if err
          console.log err
          msg.send err
          conn.end()
          return
        stream.on 'exit', (code, signal) ->
          console.log 'Stream :: exit :: code: ' + code + ', signal: ' + signal
        .on 'close', () ->
          console.log 'Stream :: close'
          conn.end()
          msg.send ">>> #{result.toString()}"
        .on 'data', (data) ->
          console.log 'STDOUT: ' + data
          result = data
        .stderr.on 'data', (data) ->
          console.log 'STDERR: ' + data
          result = data
    .connect({
      host: '54.178.209.132',
      port: 22,
      username: 'ec2-user',
      privateKey: privateKey
    })

